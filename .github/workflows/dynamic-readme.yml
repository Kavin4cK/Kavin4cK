name: Dynamic README Update

on:
  schedule:
    - cron: '0 */1 * * *'  # Every 3 hours
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  update-readme:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        
      - name: Set IST timezone
        run: |
          sudo timedatectl set-timezone Asia/Kolkata || true
          export TZ='Asia/Kolkata'
        
      - name: Update README
        env:
          TZ: 'Asia/Kolkata'
        run: |
          # FORCE IST timezone
          export TZ='Asia/Kolkata'
          
          # Get IST time - CONFIRMED
          HOUR=$(date +%H)
          echo "Current IST Hour: $HOUR"
          
          # Set greeting based on IST time
          if [ $HOUR -ge 1 ] && [ $HOUR -lt 5 ]; then
            GREETING="Good Midnight üåô"
            EMOJI="üåô"
            MSG="Burning the midnight oil? Remember to rest!"
            COLOR="4A5899"
          elif [ $HOUR -ge 5 ] && [ $HOUR -lt 12 ]; then
            GREETING="Good Morning üåÖ"
            EMOJI="üåÖ"
            MSG="Rise and shine! Time to build something amazing."
            COLOR="FFA500"
          elif [ $HOUR -ge 12 ] && [ $HOUR -lt 16 ]; then
            GREETING="Good Afternoon ‚òÄÔ∏è"
            EMOJI="‚òÄÔ∏è"
            MSG="Let's keep the momentum going!"
            COLOR="FFD700"
          elif [ $HOUR -ge 16 ] && [ $HOUR -lt 20 ]; then
            GREETING="Good Evening üåÜ"
            EMOJI="üåá"
            MSG="Evening coding sessions hit different!"
            COLOR="FF6B6B"
          else
            GREETING="Good Night üåô"
            EMOJI="‚ú®"
            MSG="Time to rest and recharge for tomorrow!"
            COLOR="1a1a2e"
          fi
          
          # Get FULL date and time in IST
          FULL_DATE=$(date '+%A, %B %d, %Y')
          FULL_TIME=$(date '+%I:%M %p IST')
          
          echo "Date: $FULL_DATE"
          echo "Time: $FULL_TIME"
          echo "Greeting: $GREETING"
          
          # Random quote
          QUOTES=(
            "Code is like humor. When you have to explain it, it's bad."
            "First, solve the problem. Then, write the code."
            "The best error message is the one that never shows up."
            "Clean code always looks like it was written by someone who cares."
            "Make it work, make it right, make it fast."
            "Talk is cheap. Show me the code."
          )
          QUOTE="${QUOTES[$((RANDOM % 6))]}"
          
          # Update using awk with IST values
          awk -v greeting="$GREETING" -v emoji="$EMOJI" -v msg="$MSG" -v color="$COLOR" \
              -v fulldate="$FULL_DATE" -v fulltime="$FULL_TIME" -v quote="$QUOTE" '
          /^# Good (Midnight|Morning|Afternoon|Evening|Night)/ { print "# " greeting; next }
          /type=waving&color=[A-F0-9]+&height/ { 
              gsub(/color=[A-F0-9]+/, "color=" color);
              gsub(/text=[^&]+/, "text=" emoji);
              print; next 
          }
          /^### üïê Last Updated:/ { 
              print "### üïê Last Updated: " fulldate " at " fulltime; 
              next 
          }
          /^\*.*\*$/ && !updated_msg && NR < 20 { 
              print "*" msg "*"; 
              updated_msg=1; 
              next 
          }
          /^```$/ && !in_code { in_code=1; print; next }
          in_code && /^"/ { print "\"" quote "\""; in_code=0; next }
          in_code { in_code=0 }
          { print }
          ' README.md > README.tmp && mv README.tmp README.md
          
      - name: Commit changes
        env:
          TZ: 'Asia/Kolkata'
        run: |
          export TZ='Asia/Kolkata'
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add README.md
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            COMMIT_TIME=$(date '+%Y-%m-%d %I:%M %p IST')
            git commit -m "ü§ñ Update: Dynamic content [$COMMIT_TIME]"
            git push
          fi
